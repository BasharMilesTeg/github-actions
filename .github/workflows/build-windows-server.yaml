name: Build Windows Server
on:
  workflow_dispatch:
    inputs:
      ntfy_repo:
        description: 'Your ntfy fork to build from (e.g., YourUsername/ntfy)'
        required: true
        default: 'BasharMilesTeg/ntfy'
      branch:
        description: 'The branch to build'
        required: true
        default: 'windows-service'

jobs:
  build-windows:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.ntfy_repo }}
          ref: ${{ github.event.inputs.branch }}

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.x'

      - name: Install node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './web/package-lock.json'

      - name: Install build dependencies, including Windows cross-compiler
        run: |
          sudo apt-get update # Ensure package lists are up to date
          sudo apt-get install -y gcc-mingw-w64-x86-64 # Install the Windows cross-compiler
          make cli-deps-all cli-deps-gcc-windows

      - name: Build Windows server binary
        run: |
          # Use the dedicated make target from the patch to build the Windows server.
          make cli-windows-amd64

      - name: Upload Windows binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ntfy-windows-server
          path: dist/*/ntfy.exe
